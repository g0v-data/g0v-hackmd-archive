# chapter9
**檔案系統 (File System)** 是作業系統的一個重要組成部分，用來管理和組織儲存裝置上的數據。以下是關於檔案系統的主要概念和結構的繁體中文解釋：  

---

### **介面 (Interface)**  
檔案系統提供一個介面，讓使用者或應用程式能方便地存取儲存裝置上的數據，而不需要了解底層的物理儲存細節。

---

### **檔案概念 (File Concept)**  
- **檔案** 是由作業系統創建的一個邏輯儲存單元，用來儲存數據或程式。  
- 與磁碟上的**物理儲存單元**（如磁軌、磁區）不同，檔案是使用者可理解的數據結構。  
- **檔案類型：**  
  1. **數據檔案 (Data File)：** 儲存文字、圖片、音訊等資料。  
  2. **程式檔案 (Program File)：** 儲存執行的指令或程式碼。  
- **內容：** 檔案的具體內容由檔案的創建者決定。

---

### **存取方法 (Access Methods)**  
- 提供不同的方式來讀取或寫入檔案，例如：  
  1. **順序存取 (Sequential Access)：** 依次從頭到尾存取檔案內容。  
  2. **隨機存取 (Random Access)：** 可以直接跳到檔案的某個位置進行操作。

---

### **目錄結構 (Directory Structure)**  
- 用來組織和管理檔案的結構，類似於樹狀結構：  
  - **單層目錄 (Single-Level Directory)：** 所有檔案都儲存在一個目錄中。  
  - **雙層目錄 (Two-Level Directory)：** 每個使用者有自己專屬的目錄。  
  - **分層目錄 (Hierarchical Directory)：** 允許子目錄的存在，形成樹狀結構。  

---

### **檔案系統掛載 (File-System Mounting)**  
- 將檔案系統與作業系統關聯，使得特定的儲存裝置（如磁碟分區）可被使用。  
- **掛載點 (Mount Point)：** 檔案系統與目錄結構相連的地方。

---

### **檔案共享 (File Sharing)**  
- 多個使用者或系統可以同時存取同一檔案。  
- 可能面臨的挑戰：  
  1. 存取控制權限的設定。  
  2. 資料同步問題。

---

### **保護 (Protection)**  
- 防止未經授權的使用者存取或修改檔案。  
- 常用機制：  
  1. **存取控制 (Access Control)：** 設定誰可以讀取、寫入或執行檔案。  
  2. **加密 (Encryption)：** 保護檔案內容免受惡意攻擊。

---

### **實現方式 (Implementation)**  
#### **檔案系統結構 (File-System Structure)**  
- 檔案系統由多層結構組成：  
  1. 使用者層：提供介面。  
  2. 邏輯層：負責檔案與磁碟的邏輯映射。  
  3. 物理層：管理實際的磁碟空間。  

#### **檔案系統實現 (File-System Implementation)**  
- 涉及如何儲存、檢索和管理檔案的元數據及實際數據。  

---

### **配置方式 (Allocation Methods)**  
- 確定如何將磁碟空間分配給檔案：  
  1. **連續配置 (Contiguous Allocation)：** 檔案的所有區塊連續存放。  
  2. **連結配置 (Linked Allocation)：** 每個區塊保存下一區塊的指標。  
  3. **索引配置 (Indexed Allocation)：** 使用索引節點來記錄檔案的所有區塊位置。  

---

### **空間管理 (Free-Space Management)**  
- 負責追蹤磁碟上未使用的空間：  
  1. **位元圖法 (Bit Vector)：** 用位元表示每個區塊的使用狀態。  
  2. **連結法 (Linked List)：** 使用鏈表記錄空閒區塊。  
  3. **群集法 (Grouping)：** 將空閒區塊分組儲存。  

--- 

透過上述機制，檔案系統能有效率地管理儲存裝置，滿足使用者的需求並保證資料的安全性和一致性。

### **檔案屬性 (File Attributes)**  
檔案的屬性是用來描述檔案的特徵及其相關資訊。以下是主要屬性：  

1. **名稱 (Name)：**  
   - 人類可讀的唯一名稱，用來標識檔案。  
2. **識別碼 (Identifier)：**  
   - 一個唯一的標籤（通常是數字），用來在檔案系統中識別該檔案。  
3. **類型 (Type)：**  
   - 系統需要此資訊來支援不同類型的檔案，例如文字檔案、執行檔案或多媒體檔案。  
4. **位置 (Location)：**  
   - 檔案在儲存裝置上的位址指標，用於定位檔案的實際存放位置。  
5. **大小 (Size)：**  
   - 檔案的當前大小（通常以位元組為單位）。  
6. **保護 (Protection)：**  
   - 控制檔案的存取權限，例如誰可以讀取、寫入或執行該檔案。  
7. **時間、日期及使用者識別 (Time, Date, and User Identification)：**  
   - 用於保護、記錄檔案的安全性以及監控其使用情況。  

---

### **檔案操作 (File Operations)**  
檔案系統允許使用者或程式進行各種操作。以下是常見的檔案操作：  

1. **建立 (Create)：**  
   - 建立一個新檔案並分配空間給它。  
2. **寫入 (Write)：**  
   - 從**寫入指標 (Write Pointer)** 所在的位置向檔案寫入數據。  
3. **讀取 (Read)：**  
   - 從**讀取指標 (Read Pointer)** 所在的位置讀取檔案的內容。  
4. **重新定位 (Reposition Within File, Seek)：**  
   - 將讀寫指標移動到檔案的不同位置，方便進行隨機存取。  
5. **刪除 (Delete)：**  
   - 從檔案系統中移除檔案，並釋放其佔用的儲存空間。  
6. **截斷/連接 (Truncate/Concatenate)：**  
   - **截斷 (Truncate)：** 刪除檔案的部分內容，使其縮小到指定大小。  
   - **連接 (Concatenate)：** 將另一個檔案的內容附加到當前檔案後。  

---

### **作業流程與表格管理**  

1. **處理：開檔表 (Process: Open-File Table)**  
   - 每個進程有一個專屬的**開檔表**，記錄該進程當前開啟的檔案及其相關資訊（例如指標位置、權限等）。  

2. **作業系統：全域檔案表 (Global File Table)**  
   - 作業系統維護一個**全域檔案表**，用來記錄所有正在被系統使用的檔案，包括開啟次數、檔案屬性等共享資訊。  

--- 

這些操作和屬性確保檔案系統能有效地管理檔案，同時為使用者提供便利性與安全性。

### **開檔表 (Open-File Tables)**  

檔案系統使用開檔表來管理進程和系統中已開啟的檔案，分為**每個進程的開檔表**和**系統範圍的全域開檔表**：  

#### **1. 每個進程的開檔表 (Per-Process Open-File Table)**  
- 每個進程維護自己的開檔表，用來追蹤該進程所開啟的所有檔案。  
- 每個開檔表條目包括：  
  1. **當前檔案指標 (Current File Pointer)：** 指示檔案操作的當前位置，例如讀寫的起點。  
  2. **存取權限 (Access Rights)：** 定義進程對檔案的存取類型（讀取、寫入、執行）。  
  3. **記錄資訊 (Accounting Information)：** 用於跟蹤與該檔案相關的操作細節。  

#### **2. 系統範圍的開檔表 (System-Wide Open-File Table)**  
- 作業系統維護一個全域的開檔表，儲存所有目前開啟檔案的進程無關資訊。  
- 每個進程的開檔表條目會指向系統範圍的開檔表，便於共享與管理。  
- 全域開檔表的內容包括：  
  1. **磁碟位置 (Disk Location)：** 檔案在儲存裝置上的位址。  
  2. **存取日期 (Access Dates)：** 記錄檔案最近的使用日期和時間。  
  3. **檔案大小 (File Size)：** 紀錄檔案的總大小。  
  4. **開啟次數 (Open Count)：** 追蹤檔案被多少進程同時開啟，用於決定檔案的關閉時機。

---

### **存取方法 (Access Methods)**  

檔案系統支援不同的存取方式來操作檔案數據，以下是三種主要存取方法的解釋：  

#### **1. 順序存取 (Sequential Access)**  
- 按照固定的順序依次讀取或寫入檔案的數據。  
- **操作：**  
  1. **讀取/寫入下一區塊 (Read/Write Next Block)：** 讀取或寫入當前指標位置的下一筆記錄。  
  2. **重置 (Reset)：** 將檔案指標重定位到檔案開頭。  
  3. **跳過/倒帶 n 筆記錄 (Skip/Rewind n Records)：** 直接跳過或返回特定數量的記錄。  
- **例子：** 類似於操作錄影帶或磁帶，需按順序快進或倒帶來存取資料。  

---

#### **2. 直接存取 (Direct Access)**  
- 又稱相對存取 (Relative Access)，允許直接存取檔案中的任意位置。  
- **操作：**  
  - 使用檔案區塊號 (Block #) 作為參數，指定位於檔案中的目標數據位置。  
- **特點：**  
  - 更靈活，適合需要快速定位檔案特定部分的應用。  
  - 此方法通常也被稱為隨機存取 (Random Access)，因為存取模式的隨機性與直接定位能力。  

---

#### **3. 索引存取 (Index Access)**  
- 利用索引結構來快速定位檔案中的數據區塊。  
- **操作流程：**  
  1. **搜尋索引檔案 (Search the Index File)：** 找到目標數據的指標 (Pointer)。  
  2. **利用指標 (Use the Pointer)：** 根據指標直接存取數據區塊。  
- **特點：**  
  - 適用於大型檔案，特別是在需要頻繁查找特定記錄的情況下。  
  - 如果檔案過大，索引本身可能會變得過於龐大，影響效能。  

---

這些存取方法提供了不同的彈性與效率，根據應用需求選擇適合的方式可以優化檔案系統的效能和操作體驗。

### **目錄結構 (Directory Structure)**  

目錄結構是檔案系統的一部分，用來組織和管理儲存裝置中的檔案及其相關資訊。以下是關於目錄結構的主要特點：  

1. **節點集合 (Collection of Nodes)：**  
   - 目錄結構由多個節點組成，每個節點儲存有關檔案的資訊，例如名稱、位置、大小和屬性等。  

2. **存放位置 (Resides on Disk)：**  
   - 目錄結構和檔案一樣，都是存放在磁碟中的，確保它們在系統重新啟動後仍能被訪問。  

---

### **目錄操作 (Directory Operations)**  

目錄結構提供了一系列操作，用於管理檔案和目錄：  

1. **搜尋檔案 (Search for a File)：**  
   - 用於在目錄中查找特定檔案的資訊或其位置。  

2. **建立檔案 (Create a File)：**  
   - 在目錄中新增一個新的檔案節點，並為其分配儲存空間。  

3. **刪除檔案 (Delete a File)：**  
   - 從目錄結構中移除檔案的節點，並釋放其佔用的磁碟空間。  

4. **列出目錄 (List a Directory)：**  
   - 顯示目錄中的所有檔案和子目錄名稱。  

5. **重新命名檔案 (Rename a File)：**  
   - 修改目錄中檔案的名稱，保持其內容和屬性不變。  

6. **遍歷檔案系統 (Traverse the File System)：**  
   - 瀏覽整個檔案系統，按層次結構檢視目錄和檔案，通常用於檔案管理或備份。  

---  

透過這些功能，目錄結構可以有效地組織和管理檔案系統中的數據，提供便捷的檔案操作和存取方式。

### **單層目錄結構 (Single-Level Directory)**  

單層目錄是最簡單的目錄結構，其中所有使用者的檔案都存放在同一個目錄中。其特性與問題包括：  

1. **特性：**  
   - 單一目錄中包含所有使用者的檔案，沒有分層或分類的概念。  

2. **問題：**  
   - **命名問題 (Naming Problem)：**  
     - 檔案名稱必須是唯一的，因為所有檔案都在同一個目錄中，這可能導致命名衝突。  
   - **分組問題 (Grouping Problem)：**  
     - 由於缺乏子目錄結構，無法對檔案進行分類，例如無法將工作檔案與個人檔案分開。  
   - **效率低下 (Poor Efficiency)：**  
     - 當檔案數量增加時，搜尋和管理檔案變得困難且低效。

---

### **雙層目錄結構 (Two-Level Directory)**  

雙層目錄為每個使用者提供獨立的目錄，解決了部分單層目錄的問題：  

1. **特性：**  
   - 每位使用者都有自己專屬的目錄，目錄中可以包含該使用者的所有檔案。  
   - **路徑名稱 (Path Name)：**  
     - 檔案的位置由**使用者名稱 + 檔案名稱**組成，明確表示檔案歸屬。  

2. **優點：**  
   - **檔案名稱可重複：** 不同使用者可以擁有相同名稱的檔案，避免命名衝突。  
   - **搜尋效率提升：** 每位使用者的檔案獨立管理，搜尋範圍變小。  

3. **缺點：**  
   - **無分組能力：** 目錄仍然是平面的，缺乏子目錄的分層結構，使用者無法進一步對檔案分類。  
   - 單層目錄的問題在每個使用者目錄內仍然存在，例如目錄內檔案過多時搜尋效率降低。

---

### **樹狀目錄結構 (Tree-Structured Directory)**  

樹狀目錄結構是更複雜且靈活的目錄結構，允許建立子目錄以組織檔案。  

1. **特性：**  
   - 目錄結構呈現樹狀，每個目錄可以包含檔案或子目錄。  
   - 支援兩種類型的路徑：  
     - **絕對路徑 (Absolute Path)：** 從根目錄開始，例如 `/spell/mail/prt/first`。  
     - **相對路徑 (Relative Path)：** 從當前目錄開始，例如 `/prt/first`。  

2. **操作範例：**  
   - 當前目錄為 `/mail` 時：  
     - **建立新目錄：** 使用 `mkdir count` 命令在 `/mail` 下建立名為 `count` 的子目錄。  
     - **刪除目錄：** 如果刪除 `/mail`，則整個以 `/mail` 為根的子樹（包括其所有子目錄與檔案）都會被刪除。  

3. **優點：**  
   - **搜尋效率高：** 目錄結構清晰，檔案和目錄容易定位。  
   - **分組能力：** 支援子目錄結構，方便對檔案進行分類和分組管理。  

---

樹狀目錄結構彌補了單層和雙層目錄的不足，提供了更強大的組織能力和操作靈活性，是現代檔案系統的主流設計。

### **無環圖目錄結構 (Acyclic-Graph Directory)**  

無環圖目錄是一種目錄結構，其中不允許目錄之間形成循環。其特性與問題包括：  

1. **特性：**  
   - **無循環 (No Loop)：** 目錄結構中沒有環路，避免無限循環的問題。  
   - **共享目錄與檔案 (Shared Directories and Files)：** 支援多個使用者或項目共享檔案或目錄，例如聯合項目中的資源共享。  
   - **多重絕對路徑 (Multiple Absolute Paths)：** 一個檔案可能有多個不同的絕對路徑，因為它可以被多個目錄指向。  

2. **刪除檔案的問題：**  
   - **刪除連結但不刪檔案：**  
     - 如果只刪除某個目錄中的檔案連結，但檔案仍有其他連結存在，檔案不會被刪除。  
   - **刪除檔案但不刪連結：**  
     - 如果刪除檔案，但仍有指向該檔案的連結存在，就會產生**懸空指標 (Dangling Pointer)**，導致指向無效的檔案位置。  

3. **解決方案：**  
   - 使用**引用計數 (Reference Counter)：**  
     - 每個檔案有一個計數器，記錄指向該檔案的連結數量。  
     - 當引用計數減為 0 時，表示沒有任何連結指向該檔案，檔案即可安全刪除。  

---

### **一般圖目錄結構 (General-Graph Directory)**  

一般圖目錄允許目錄之間形成循環，結構更加靈活，但也引入了一些挑戰。  

1. **特性：**  
   - **允許循環 (May Contain Loops)：**  
     - 目錄結構可能包含循環，例如一個目錄指向自己或透過其他目錄間接形成環路。  
   - **無窮迴圈 (Infinite Loop)：**  
     - 若在循環中不慎進行搜尋，可能導致程式陷入無窮迴圈，無法完成操作。  

2. **問題：**  
   - **引用計數失效：**  
     - 循環會導致引用計數無法正確判斷是否可以刪除檔案，例如當兩個目錄互相引用時，引用計數永遠不為 0。  

3. **解決方案：**  
   - **垃圾回收 (Garbage Collection)：**  
     - 使用一種特定機制判斷當最後一個引用被刪除時，檔案所佔用的磁碟空間可以被重新分配。  
   - **循環檢測 (Cycle Detection)：**  
     - 在建立連結時執行檢測演算法，確保新的連結不會引入循環。  

---

無環圖目錄結構適用於需要嚴格避免循環的環境，而一般圖目錄則適合需要更多彈性的應用，但需額外的管理機制來處理循環問題，確保系統運行穩定。

### **檔案系統掛載 (File-System Mounting)**  

在使用檔案系統之前，必須先將其掛載到目錄結構中，以下是檔案系統掛載的主要概念：  

1. **掛載必要性：**  
   - 檔案系統在被訪問前，必須透過掛載 (Mounting) 來整合到作業系統的檔案目錄中。  

2. **掛載點 (Mount Point)：**  
   - 掛載點是檔案系統整合到目錄結構中的根路徑。例如，將一個未掛載的檔案系統掛載到 `/mnt/usb`。  

3. **掛載時機：**  
   - **開機時 (Boot Time)：**  
     - 系統啟動時，會自動掛載必要的檔案系統（如根檔案系統）。  
   - **執行時自動掛載 (Automatically at Run-Time)：**  
     - 根據需求，系統會在執行期間自動掛載檔案系統，例如插入 USB 裝置時。  
   - **執行時手動掛載 (Manually at Run-Time)：**  
     - 由使用者使用命令手動掛載檔案系統，例如 `mount` 指令。

---

### **檔案共享 (File Sharing)**  

檔案共享是多使用者系統中的重要功能，使多個使用者可以共同存取檔案：  

1. **共享的重要性：**  
   - 在多使用者系統中，檔案共享有助於協同工作和提高資源使用效率。  

2. **使用者識別：**  
   - **使用者 ID (User ID)：**  
     - 唯一標識每位使用者，並根據使用者設定檔案的存取權限與保護措施。  
   - **群組 ID (Group ID)：**  
     - 使用者可以被分配到一個群組中，允許同群組成員擁有檔案的共享存取權。  

3. **檔案的三種屬性：**  
   - **擁有者 (Owner)：**  
     - 定義檔案擁有者的權限，例如讀取、寫入和執行的特權。  
   - **群組 (Group)：**  
     - 根據擁有者的設定，允許群組成員存取檔案。  
   - **其他人 (Others)：**  
     - 非擁有者或群組成員的其他使用者，其存取權限也由擁有者設定。  

---

透過檔案系統掛載，檔案可以被整合進作業系統的目錄結構中；而檔案共享則依據使用者與群組權限，實現多使用者系統中的高效協作與資源共享。

### **存取控制與群組 (Access-Control and Groups)**  

存取控制機制用於確保檔案能夠根據使用者權限被正確存取。以下是相關內容的解釋：  

1. **存取控制清單 (ACL)：**  
   - 為每個檔案建立一個存取控制清單，列出哪些使用者或群組擁有哪些操作的權限。  
   - 在使用者請求存取檔案時，系統會檢查該操作是否符合 ACL 的定義。  

2. **存取模式 (Mode of Access)：**  
   - 檔案的存取模式包括：  
     - **讀取 (Read, R)**：允許查看檔案內容。  
     - **寫入 (Write, W)**：允許修改檔案內容。  
     - **執行 (Execute, X)**：允許執行檔案（例如程式）。  

3. **使用者分級與權限 (3 Classes of Users)：**  
   - 每個檔案分為三種使用者群組，分別對應不同的存取權限：  
     - **擁有者 (Owner Access)：**  
       - 擁有檔案的使用者，權限通常最大（RWX = 111 = 7）。  
     - **群組 (Group Access)：**  
       - 與檔案擁有者屬於相同群組的其他使用者，權限可能較少（RWX = 110 = 6）。  
     - **公眾 (Public, Others Access)：**  
       - 所有其他使用者，權限最少（RWX = 001 = 1）。  

---

### **檔案保護 (File Protection)**  

檔案保護用於防止檔案受到不當的存取或損壞。以下是檔案保護的重點：  

1. **控制權限 (Control Access)：**  
   - **檔案擁有者/建立者的控制權：**  
     - 檔案擁有者應該能夠決定哪些操作可以被執行，並由哪些人執行。  

2. **檔案的保護目標：**  
   - **防止物理損壞 (Reliability)：**  
     - 採用技術如 RAID（獨立磁碟冗餘陣列）來提高檔案的可靠性，減少因硬體故障導致的資料遺失。  
   - **防止不當存取 (Protection)：**  
     - 使用密碼或其他存取控制技術來保護檔案免受未經授權的使用者存取。  

---

ACL 和分級權限確保檔案能被正確地分享或保護，而檔案保護機制進一步增強了檔案的安全性與穩定性。